---
import type { GetStaticPaths } from "astro";
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostItem from '../../components/Blog/PostItem.astro';
import Breadcrumbs from '../../components/Common/Breadcrumbs.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('blog');
  
  // Logic: Filter out drafts in production
  const livePosts = allPosts.filter((post) => {
    if (import.meta.env.PROD && post.data.draft === true) return false;
    return true;
  });

  const sortedPosts = livePosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );

  // PAGINATION SIZE: 
  // Changed from 6 to 9 or 12 so the grid (3 columns) looks balanced (divisible by 3)
  return paginate(sortedPosts, { pageSize: 9 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
---

<BaseLayout title={`Blog - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
  <section>
    
    <Breadcrumbs />

    <div class="relative mb-10 overflow-hidden rounded-3xl border border-base-content/10 bg-base-100/75 p-8 shadow-xl shadow-base-content/5 backdrop-blur-sm md:p-10">
      <div class="pointer-events-none absolute -right-8 -top-10 h-36 w-36 rounded-full bg-primary/20 blur-3xl"></div>
      <div class="pointer-events-none absolute -left-10 bottom-0 h-36 w-36 rounded-full bg-secondary/20 blur-3xl"></div>
      <p class="badge badge-outline badge-primary mb-4">Archive</p>
      <h1 class="mb-3 text-4xl font-black tracking-tight md:text-5xl">Blog Archive</h1>
      <p class="max-w-2xl text-base text-base-content/70 md:text-lg">
        Explore thoughts on engineering, philosophy, and system design.
      </p>
      <p class="mt-3 text-sm font-medium text-base-content/55">
        Page {page.currentPage} of {page.lastPage}
      </p>
    </div>
    
<ul class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
      {page.data.map((post) => (
        <div class="h-full">
            <PostItem post={post} />
        </div>
      ))}
    </ul>

    {/* Pagination Controls */}
    <div class="mt-14 flex justify-center">
      <div class="join grid w-full max-w-sm grid-cols-2 rounded-xl border border-base-content/10 bg-base-100/75 p-1 shadow-lg shadow-base-content/5 backdrop-blur-sm">
        {page.url.prev ? (
          <a href={page.url.prev} class="join-item btn btn-ghost hover:bg-base-200/70">« Previous</a>
        ) : (
          <button class="join-item btn btn-ghost btn-disabled">« Previous</button>
        )}
        
        {page.url.next ? (
          <a href={page.url.next} class="join-item btn btn-ghost hover:bg-base-200/70">Next »</a>
        ) : (
          <button class="join-item btn btn-ghost btn-disabled">Next »</button>
        )}
      </div>
    </div>

    <div class="mt-4 text-center font-mono text-xs text-base-content/40">
        Showing {page.start + 1}-{page.end + 1} of {page.total} posts
    </div>
  </section>
</BaseLayout>
