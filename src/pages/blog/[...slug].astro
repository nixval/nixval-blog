---
import { getCollection, render } from 'astro:content';
import BlogPostLayout from '../../layouts/BlogPostLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  
  // Filter drafts in production
  const livePosts = posts.filter((post) => {
    if (import.meta.env.PROD && post.data.draft === true) return false;
    return true;
  });

  return livePosts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// --- NAVIGATION LOGIC ---
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const currentPostIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost = currentPostIndex < allPosts.length - 1 ? allPosts[currentPostIndex + 1] : null;
const nextPost = currentPostIndex > 0 ? allPosts[currentPostIndex - 1] : null;

// --- RELATED POSTS LOGIC ---
const currentTags = post.data.tags || [];
const relatedPosts = allPosts
  .filter((p) => p.id !== post.id && !p.data.draft)
  .map((p) => {
    const otherTags = p.data.tags || [];
    const sharedTags = currentTags.filter((tag) => otherTags.includes(tag));
    return { ...p, sharedTagCount: sharedTags.length };
  })
  .filter((p) => p.sharedTagCount > 0)
  .sort((a, b) => b.sharedTagCount - a.sharedTagCount)
  .slice(0, 3);

// --- SERIES LOGIC (NEW) ---
const seriesName = post.data.series;
let seriesPosts: typeof allPosts = [];
if (seriesName) {
  seriesPosts = allPosts.filter((p) => p.data.series === seriesName && !p.data.draft);
}
---

<BlogPostLayout 
  title={post.data.title}
  description={post.data.description}
  pubDate={post.data.pubDate}
  updatedDate={post.data.updatedDate}
  heroImage={post.data.heroImage}
  headings={headings}       
  readTimeContent={post.body}
  tags={post.data.tags}
  
  prevPost={prevPost}
  nextPost={nextPost}
  relatedPosts={relatedPosts}
  id={post.id}

  /* PASS SERIES PROPS */
  seriesName={seriesName}
  seriesPosts={seriesPosts}
  currentPost={post}
>
  <Content />
</BlogPostLayout>
