---
const themes = [
  "light", "dark", "cupcake", "bumblebee", "emerald", "corporate", 
  "synthwave", "retro", "cyberpunk", "valentine", "halloween", "garden", 
  "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe", "black", 
  "luxury", "dracula", "cmyk", "autumn", "business", "acid", "lemonade", 
  "night", "coffee", "winter", "dim", "nord", "sunset", "caramellatte",
  "abyss", "silk"
];
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle" aria-label="Theme Switcher">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </div>
  
  <div tabindex="0" class="dropdown-content bg-base-200 text-base-content rounded-box z-[99] mt-3 w-[280px] md:w-[480px] p-4 shadow-2xl border border-base-content/10">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar">
      {themes.map((theme) => (
        <button 
          class="theme-btn btn btn-sm btn-ghost justify-between font-normal capitalize border border-base-content/10 hover:border-primary"
          data-set-theme={theme}
        >
          <span class="truncate">{theme}</span>
          <div data-theme={theme} class="flex gap-1 p-1 rounded bg-base-100">
            <div class="bg-primary size-2 rounded-full"></div>
            <div class="bg-secondary size-2 rounded-full"></div>
            <div class="bg-accent size-2 rounded-full"></div>
            <div class="bg-neutral size-2 rounded-full"></div>
          </div>
        </button>
      ))}
    </div>
  </div>
</div>

<script is:inline>
  // 1. Core Function to Apply Theme
  function applyTheme() {
    // Priority: LocalStorage -> Document Attribute -> System Preference
    const savedTheme = localStorage.getItem('theme') || document.documentElement.getAttribute('data-theme');
    
    if (savedTheme) {
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateActiveButton(savedTheme);
      console.log(`[Theme] Applied: ${savedTheme}`);
    }
  }

  // 2. Update UI (Active Button State)
  function updateActiveButton(currentTheme) {
    document.querySelectorAll('.theme-btn').forEach((btn) => {
      const btnTheme = btn.getAttribute('data-set-theme');
      if (btnTheme === currentTheme) {
        btn.classList.add('btn-active', 'btn-primary');
        btn.classList.remove('btn-ghost');
      } else {
        btn.classList.remove('btn-active', 'btn-primary');
        btn.classList.add('btn-ghost');
      }
    });
  }

  // 3. Setup Event Listeners (Runs on every page navigation)
  function setupThemeListeners() {
    const themeController = document.querySelector('.dropdown-content');
    if (!themeController) return;

    // Remove old listeners to avoid duplicates (optional safety)
    const newController = themeController.cloneNode(true);
    themeController.parentNode.replaceChild(newController, themeController);

    newController.addEventListener('click', (e) => {
      const target = e.target;
      const btn = target.closest('.theme-btn');
      
      if (btn) {
        const newTheme = btn.getAttribute('data-set-theme');
        if (newTheme) {
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          updateActiveButton(newTheme);
        }
      }
    });
  }

  // --- LIFECYCLE HOOKS FOR VIEW TRANSITIONS ---

  // Initial Load
  applyTheme();
  setupThemeListeners();

  // After Swap (When you navigate to a new page)
  // This restores the theme BEFORE the user sees the new page
  document.addEventListener('astro:after-swap', () => {
    applyTheme();
    setupThemeListeners();
  });
</script>
