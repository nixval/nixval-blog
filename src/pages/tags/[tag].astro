---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostItem from '../../components/Blog/PostItem.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  
  // 1. Get all unique tags
  const uniqueTags = [...new Set(allPosts.map((post) => post.data.tags || []).flat())];

  // 2. Return a path for each tag
  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) => 
      post.data.tags?.includes(tag)
    );
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged with ${tag}`}>
  <section class="max-w-4xl mx-auto my-8">
    <div class="flex items-center gap-4 mb-8 pb-4 border-b border-base-content/10">
      <h1 class="text-3xl font-bold">
        <span class="opacity-50 font-normal">Topic:</span> #{tag}
      </h1>
      <span class="badge badge-neutral">{posts.length} posts</span>
      <a href="/blog" class="ml-auto btn btn-ghost btn-sm">Clear Filter</a>
    </div>

    <ul class="grid gap-4">
      {posts.map((post) => (
        <PostItem post={post} />
      ))}
    </ul>
  </section>
</BaseLayout>
