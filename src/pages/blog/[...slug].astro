---
import { getCollection, render } from 'astro:content';
import BlogPostLayout from '../../layouts/BlogPostLayout.astro';

export async function getStaticPaths() {
const posts = await getCollection('blog');
  
  // LOGIC: Filter out drafts ONLY in production build
  // In 'npm run dev', import.meta.env.PROD is false, so we see everything.
  const livePosts = posts.filter((post) => {
    if (import.meta.env.PROD && post.data.draft === true) {
      return false;
    }
    return true;
  });

  return livePosts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// --- LOGIC: Get Previous/Next & Related Posts ---
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const currentPostIndex = allPosts.findIndex((p) => p.id === post.id);

// Previous Post (Older)
const prevPost = currentPostIndex < allPosts.length - 1 
  ? allPosts[currentPostIndex + 1] 
  : null;

// Next Post (Newer)
const nextPost = currentPostIndex > 0 
  ? allPosts[currentPostIndex - 1] 
  : null;

// Related Posts Logic
// 1. Filter out current post
// 2. Find posts that share at least one tag
// 3. Sort by number of shared tags (relevance), then by date
const currentTags = post.data.tags || [];
const relatedPosts = allPosts
  .filter((p) => p.id !== post.id) // Exclude current
  .map((p) => {
    const otherTags = p.data.tags || [];
    const sharedTags = currentTags.filter((tag) => otherTags.includes(tag));
    return {
      ...p,
      sharedTagCount: sharedTags.length,
    };
  })
  .filter((p) => p.sharedTagCount > 0) // Must share at least one tag
  .sort((a, b) => {
    // Primary sort: Most shared tags
    if (b.sharedTagCount !== a.sharedTagCount) {
      return b.sharedTagCount - a.sharedTagCount;
    }
    // Secondary sort: Recent date
    return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
  })
  .slice(0, 3); // Take top 3
---

<BlogPostLayout 
  title={post.data.title}
  description={post.data.description}
  pubDate={post.data.pubDate}
  updatedDate={post.data.updatedDate}
  heroImage={post.data.heroImage}
  headings={headings}       
  readTimeContent={post.body}
  tags={post.data.tags}
  
  /* New Props */
  prevPost={prevPost}
  nextPost={nextPost}
  relatedPosts={relatedPosts}
>
  <Content />
</BlogPostLayout>
